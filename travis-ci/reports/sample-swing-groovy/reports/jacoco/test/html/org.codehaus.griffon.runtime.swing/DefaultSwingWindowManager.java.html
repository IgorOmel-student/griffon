<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultSwingWindowManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-swing-groovy</a> &gt; <a href="index.source.html" class="el_package">org.codehaus.griffon.runtime.swing</a> &gt; <span class="el_source">DefaultSwingWindowManager.java</span></div><h1>DefaultSwingWindowManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.codehaus.griffon.runtime.swing;

import griffon.core.ApplicationEvent;
import griffon.core.GriffonApplication;
import griffon.core.env.ApplicationPhase;
import griffon.swing.SwingWindowDisplayHandler;
import griffon.swing.SwingWindowManager;
import griffon.util.GriffonNameUtils;
import org.codehaus.griffon.runtime.core.view.AbstractWindowManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import javax.inject.Inject;
import javax.inject.Named;
import javax.swing.JInternalFrame;
import javax.swing.WindowConstants;
import javax.swing.event.InternalFrameAdapter;
import javax.swing.event.InternalFrameEvent;
import java.awt.Window;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.util.Collection;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Set;

import static griffon.util.GriffonNameUtils.requireNonBlank;
import static java.util.Arrays.asList;
import static java.util.Collections.unmodifiableCollection;
import static java.util.Objects.requireNonNull;

/**
 * @author Andres Almiray
 * @since 2.0.0
 */
public class DefaultSwingWindowManager extends AbstractWindowManager&lt;Window&gt; implements SwingWindowManager {
<span class="fc" id="L57">    private static final Logger LOG = LoggerFactory.getLogger(DefaultSwingWindowManager.class);</span>
<span class="fc" id="L58">    private final WindowHelper windowHelper = new WindowHelper();</span>
<span class="fc" id="L59">    private final ComponentHelper componentHelper = new ComponentHelper();</span>
<span class="fc" id="L60">    private final InternalFrameHelper internalFrameHelper = new InternalFrameHelper();</span>
<span class="fc" id="L61">    private final Map&lt;String, JInternalFrame&gt; internalFrames = Collections.synchronizedMap(new LinkedHashMap&lt;String, JInternalFrame&gt;());</span>
<span class="fc" id="L62">    private boolean hideBeforeHandler = false;</span>

    @Inject
    @Nonnull
    public DefaultSwingWindowManager(@Nonnull GriffonApplication application, @Nonnull @Named(&quot;windowDisplayHandler&quot;) SwingWindowDisplayHandler windowDisplayHandler) {
<span class="fc" id="L67">        super(application, windowDisplayHandler);</span>
<span class="fc" id="L68">        requireNonNull(application.getEventRouter(), &quot;Argument 'application.eventRouter' must not be null&quot;);</span>
<span class="fc" id="L69">    }</span>

    /**
     * Finds a JInternalFrame by name.
     *
     * @param name the value of the name: property
     * @return a JInternalFrame if a match is found, null otherwise.
     * @since 2.0.0
     */
    public JInternalFrame findInternalFrame(String name) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!GriffonNameUtils.isBlank(name)) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            for (JInternalFrame internalFrame : internalFrames.values()) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (name.equals(internalFrame.getName())) return internalFrame;</span>
<span class="nc" id="L82">            }</span>
        }
<span class="nc" id="L84">        return null;</span>
    }

    @Nonnull
    @Override
    public Set&lt;String&gt; getInternalWindowNames() {
<span class="nc" id="L90">        return Collections.unmodifiableSet(internalFrames.keySet());</span>
    }

    @Nullable
    @Override
    public String findInternalWindowName(@Nonnull JInternalFrame window) {
<span class="nc" id="L96">        requireNonNull(window, ERROR_WINDOW_NULL);</span>
<span class="nc" id="L97">        synchronized (internalFrames) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            for (Map.Entry&lt;String, JInternalFrame&gt; e : internalFrames.entrySet()) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                if (e.getValue().equals(window)) {</span>
<span class="nc" id="L100">                    return e.getKey();</span>
                }
<span class="nc" id="L102">            }</span>
<span class="nc" id="L103">        }</span>
<span class="nc" id="L104">        return null;</span>
    }

    @Override
    public int indexOfInternal(@Nonnull JInternalFrame window) {
<span class="nc" id="L109">        requireNonNull(window, ERROR_WINDOW_NULL);</span>
<span class="nc" id="L110">        synchronized (internalFrames) {</span>
<span class="nc" id="L111">            int index = 0;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            for (JInternalFrame w : internalFrames.values()) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (window.equals(w)) {</span>
<span class="nc" id="L114">                    return index;</span>
                }
<span class="nc" id="L116">                index++;</span>
<span class="nc" id="L117">            }</span>
<span class="nc" id="L118">        }</span>
<span class="nc" id="L119">        return -1;</span>
    }

    /**
     * Returns the list of internal frames managed by this manager.
     *
     * @return a List of currently managed internal frames
     * @since 2.0.0
     */
    public Collection&lt;JInternalFrame&gt; getInternalFrames() {
<span class="nc" id="L129">        return unmodifiableCollection(internalFrames.values());</span>
    }

    /**
     * Registers an internal frame on this manager if an only if the internal frame is not null
     * and it's not registered already.
     *
     * @param name          the value of the of the Window's name
     * @param internalFrame the internal frame to be added to the list of managed internal frames
     * @since 2.0.0
     */
    public void attach(@Nonnull String name, @Nonnull JInternalFrame internalFrame) {
<span class="nc" id="L141">        requireNonBlank(name, ERROR_NAME_BLANK);</span>
<span class="nc" id="L142">        requireNonNull(internalFrame, ERROR_WINDOW_NULL);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (internalFrames.containsKey(name)) {</span>
<span class="nc" id="L144">            JInternalFrame window2 = internalFrames.get(name);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (window2 != internalFrame) {</span>
<span class="nc" id="L146">                detach(name);</span>
            }
        }

<span class="nc" id="L150">        doAttach(internalFrame);</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L153">            LOG.debug(&quot;Attaching internal frame with name: '&quot; + name + &quot;' at index &quot; + internalFrames.size() + &quot; &quot; + internalFrame);</span>
        }
<span class="nc" id="L155">        internalFrames.put(name, internalFrame);</span>
<span class="nc" id="L156">        event(ApplicationEvent.WINDOW_ATTACHED, asList(name, internalFrame));</span>
<span class="nc" id="L157">    }</span>

    protected void doAttach(@Nonnull JInternalFrame internalFrame) {
<span class="nc" id="L160">        internalFrame.addInternalFrameListener(internalFrameHelper);</span>
<span class="nc" id="L161">        internalFrame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L162">    }</span>

    /**
     * Removes the internal frame from the list of manages internal frames if and only if it
     * is registered with this manager.
     *
     * @param name the value of the of the Window's name
     * @since 2.0.0
     */
    public void detach(@Nonnull String name) {
<span class="nc" id="L172">        requireNonBlank(name, ERROR_NAME_BLANK);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (internalFrames.containsKey(name)) {</span>
<span class="nc" id="L174">            JInternalFrame window = internalFrames.get(name);</span>

<span class="nc" id="L176">            doDetach(window);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L179">                LOG.debug(&quot;Detaching internalFrame with name: '&quot; + name + &quot;' &quot; + window);</span>
            }
<span class="nc" id="L181">            internalFrames.remove(name);</span>
<span class="nc" id="L182">            event(ApplicationEvent.WINDOW_DETACHED, asList(name, window));</span>
        }
<span class="nc" id="L184">    }</span>

    protected void doDetach(@Nonnull JInternalFrame internalFrame) {
<span class="nc" id="L187">        internalFrame.removeInternalFrameListener(internalFrameHelper);</span>
<span class="nc" id="L188">    }</span>

    /**
     * Shows the internal frame.&lt;p&gt;
     * This method is executed &lt;b&gt;SYNCHRONOUSLY&lt;/b&gt; in the UI thread.
     *
     * @param internalFrame the internal frame to show
     * @since 2.0.0
     */
    public void show(@Nonnull final JInternalFrame internalFrame) {
<span class="nc" id="L198">        requireNonNull(internalFrame, ERROR_WINDOW_NULL);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!internalFrames.containsValue(internalFrame)) {</span>
<span class="nc" id="L200">            return;</span>
        }

<span class="nc" id="L203">        String windowName = null;</span>
<span class="nc" id="L204">        int windowIndex = -1;</span>
<span class="nc" id="L205">        synchronized (internalFrames) {</span>
<span class="nc" id="L206">            int i = 0;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            for (Map.Entry&lt;String, JInternalFrame&gt; entry : internalFrames.entrySet()) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                if (entry.getValue() == internalFrame) {</span>
<span class="nc" id="L209">                    windowName = entry.getKey();</span>
<span class="nc" id="L210">                    windowIndex = i;</span>
<span class="nc" id="L211">                    break;</span>
                }
<span class="nc" id="L213">                i++;</span>
<span class="nc" id="L214">            }</span>
<span class="nc" id="L215">        }</span>

<span class="nc" id="L217">        final String name = windowName;</span>
<span class="nc" id="L218">        final int index = windowIndex;</span>

<span class="nc" id="L220">        getApplication().getUIThreadManager().runInsideUIAsync(new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L223">                    LOG.debug(&quot;Showing window with name: '&quot; + name + &quot;' at index &quot; + index + &quot; &quot; + internalFrame);</span>
                }
                //noinspection ConstantConditions
<span class="nc" id="L226">                resolveSwingWindowDisplayHandler().show(name, internalFrame);</span>
<span class="nc" id="L227">            }</span>
        });
<span class="nc" id="L229">    }</span>

    /**
     * Hides the internal frame.&lt;p&gt;
     * This method is executed &lt;b&gt;SYNCHRONOUSLY&lt;/b&gt; in the UI thread.
     *
     * @param internalFrame the internal frame to hide
     * @since 2.0.0
     */
    public void hide(@Nonnull final JInternalFrame internalFrame) {
<span class="nc" id="L239">        requireNonNull(internalFrame, ERROR_WINDOW_NULL);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (!internalFrames.containsValue(internalFrame)) {</span>
<span class="nc" id="L241">            return;</span>
        }

<span class="nc" id="L244">        String windowName = null;</span>
<span class="nc" id="L245">        int windowIndex = -1;</span>
<span class="nc" id="L246">        synchronized (internalFrames) {</span>
<span class="nc" id="L247">            int i = 0;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            for (Map.Entry&lt;String, JInternalFrame&gt; entry : internalFrames.entrySet()) {</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (entry.getValue() == internalFrame) {</span>
<span class="nc" id="L250">                    windowName = entry.getKey();</span>
<span class="nc" id="L251">                    windowIndex = i;</span>
<span class="nc" id="L252">                    break;</span>
                }
<span class="nc" id="L254">                i++;</span>
<span class="nc" id="L255">            }</span>
<span class="nc" id="L256">        }</span>

<span class="nc" id="L258">        final String name = windowName;</span>
<span class="nc" id="L259">        final int index = windowIndex;</span>

<span class="nc" id="L261">        getApplication().getUIThreadManager().runInsideUIAsync(new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L263" title="All 2 branches missed.">                if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L264">                    LOG.debug(&quot;Hiding window with name: '&quot; + name + &quot;' at index &quot; + index + &quot; &quot; + internalFrame);</span>
                }
                //noinspection ConstantConditions
<span class="nc" id="L267">                resolveSwingWindowDisplayHandler().hide(name, internalFrame);</span>
<span class="nc" id="L268">            }</span>
        });
<span class="nc" id="L270">    }</span>

    /**
     * Should the window be hidden before all ShutdownHandlers be called ?
     *
     * @return current value
     */
    public boolean isHideBeforeHandler() {
<span class="nc" id="L278">        return hideBeforeHandler;</span>
    }

    /**
     * Set if the window should be hidden before all ShutdownHandler be called.
     *
     * @param hideBeforeHandler new value
     */
    public void setHideBeforeHandler(boolean hideBeforeHandler) {
<span class="nc" id="L287">        this.hideBeforeHandler = hideBeforeHandler;</span>
<span class="nc" id="L288">    }</span>

    @Nonnull
    protected SwingWindowDisplayHandler resolveSwingWindowDisplayHandler() {
<span class="nc" id="L292">        return (SwingWindowDisplayHandler) resolveWindowDisplayHandler();</span>
    }

    @Override
    protected void doAttach(@Nonnull Window window) {
<span class="nc" id="L297">        requireNonNull(window, ERROR_WINDOW_NULL);</span>
<span class="nc" id="L298">        window.addWindowListener(windowHelper);</span>
<span class="nc" id="L299">        window.addComponentListener(componentHelper);</span>
<span class="nc" id="L300">    }</span>

    @Override
    protected void doDetach(@Nonnull Window window) {
<span class="nc" id="L304">        requireNonNull(window, ERROR_WINDOW_NULL);</span>
<span class="nc" id="L305">        window.removeWindowListener(windowHelper);</span>
<span class="nc" id="L306">        window.removeComponentListener(componentHelper);</span>
<span class="nc" id="L307">    }</span>

    @Override
    protected boolean isWindowVisible(@Nonnull Window window) {
<span class="nc" id="L311">        requireNonNull(window, ERROR_WINDOW_NULL);</span>
<span class="nc" id="L312">        return window.isVisible();</span>
    }

    /**
     * WindowAdapter that optionally invokes hide() when the window is about to be closed.
     *
     * @author Andres Almiray
     */
<span class="fc" id="L320">    private class WindowHelper extends WindowAdapter {</span>
        public void windowClosing(WindowEvent event) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (getApplication().getPhase() == ApplicationPhase.SHUTDOWN) {</span>
<span class="nc" id="L323">                return;</span>
            }
<span class="nc" id="L325">            int visibleWindows = countVisibleWindows();</span>

<span class="nc bnc" id="L327" title="All 4 branches missed.">            if (isHideBeforeHandler() || visibleWindows &gt; 0) {</span>
<span class="nc" id="L328">                hide(event.getWindow());</span>
            }

<span class="nc bnc" id="L331" title="All 4 branches missed.">            if (visibleWindows &lt;= 1 &amp;&amp; isAutoShutdown()) {</span>
<span class="nc" id="L332">                LOG.debug(&quot;Attempting to shutdown application&quot;);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">                if (!getApplication().shutdown()) show(event.getWindow());</span>
            }
<span class="nc" id="L335">        }</span>
    }

    /**
     * ComponentAdapter that triggers application events when a window is shown/hidden.
     *
     * @author Andres Almiray
     */
<span class="fc" id="L343">    private class ComponentHelper extends ComponentAdapter {</span>
        /**
         * Triggers a &lt;tt&gt;WindowShown&lt;/tt&gt; event with the window as sole argument
         */
        public void componentShown(ComponentEvent event) {
<span class="nc" id="L348">            Window window = (Window) event.getSource();</span>
<span class="nc" id="L349">            event(ApplicationEvent.WINDOW_SHOWN, asList(findWindowName(window), window));</span>
<span class="nc" id="L350">        }</span>

        /**
         * Triggers a &lt;tt&gt;WindowHidden&lt;/tt&gt; event with the window as sole argument
         */
        public void componentHidden(ComponentEvent event) {
<span class="nc" id="L356">            Window window = (Window) event.getSource();</span>
<span class="nc" id="L357">            event(ApplicationEvent.WINDOW_HIDDEN, asList(findWindowName(window), window));</span>
<span class="nc" id="L358">        }</span>
    }

    /**
     * InternalFrameAdapter that triggers application events when a window is shown/hidden,
     * it also invokes hide() when the window is about to be closed.
     *
     * @author Andres Almiray
     */
<span class="fc" id="L367">    private class InternalFrameHelper extends InternalFrameAdapter {</span>
        public void internalFrameClosing(InternalFrameEvent event) {
<span class="nc" id="L369">            hide(event.getInternalFrame());</span>
<span class="nc" id="L370">        }</span>

        /**
         * Triggers a &lt;tt&gt;WindowShown&lt;/tt&gt; event with the internal frame as sole argument
         */
        public void internalFrameOpened(InternalFrameEvent event) {
<span class="nc" id="L376">            JInternalFrame window = (JInternalFrame) event.getSource();</span>
<span class="nc" id="L377">            event(ApplicationEvent.WINDOW_SHOWN, asList(findInternalWindowName(window), window));</span>

<span class="nc" id="L379">        }</span>

        /**
         * Triggers a &lt;tt&gt;WindowHidden&lt;/tt&gt; event with the internal frame as sole argument
         */
        public void internalFrameClosed(InternalFrameEvent event) {
<span class="nc" id="L385">            JInternalFrame window = (JInternalFrame) event.getSource();</span>
<span class="nc" id="L386">            event(ApplicationEvent.WINDOW_HIDDEN, asList(findInternalWindowName(window), window));</span>
<span class="nc" id="L387">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>