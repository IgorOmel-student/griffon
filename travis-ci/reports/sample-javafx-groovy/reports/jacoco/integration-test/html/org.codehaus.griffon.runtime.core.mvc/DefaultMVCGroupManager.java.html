<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultMVCGroupManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-javafx-groovy</a> &gt; <a href="index.source.html" class="el_package">org.codehaus.griffon.runtime.core.mvc</a> &gt; <span class="el_source">DefaultMVCGroupManager.java</span></div><h1>DefaultMVCGroupManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.codehaus.griffon.runtime.core.mvc;

import griffon.core.ApplicationClassLoader;
import griffon.core.ApplicationEvent;
import griffon.core.GriffonApplication;
import griffon.core.artifact.ArtifactManager;
import griffon.core.artifact.GriffonArtifact;
import griffon.core.artifact.GriffonClass;
import griffon.core.artifact.GriffonController;
import griffon.core.artifact.GriffonMvcArtifact;
import griffon.core.artifact.GriffonView;
import griffon.core.mvc.MVCGroup;
import griffon.core.mvc.MVCGroupConfiguration;
import griffon.exceptions.FieldException;
import griffon.exceptions.GriffonException;
import griffon.exceptions.GriffonViewInitializationException;
import griffon.exceptions.MVCGroupInstantiationException;
import griffon.exceptions.NewInstanceException;
import griffon.inject.Contextual;
import griffon.inject.MVCMember;
import griffon.util.CollectionUtils;
import griffon.util.Instantiator;
import org.codehaus.griffon.runtime.core.injection.InjectionUnitOfWork;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import javax.inject.Inject;
import java.beans.PropertyDescriptor;
import java.lang.reflect.AnnotatedElement;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import static griffon.core.GriffonExceptionHandler.sanitize;
import static griffon.util.AnnotationUtils.annotationsOfMethodParameter;
import static griffon.util.AnnotationUtils.findAnnotation;
import static griffon.util.AnnotationUtils.namesFor;
import static griffon.util.ConfigUtils.getConfigValueAsBoolean;
import static griffon.util.GriffonClassUtils.getAllDeclaredFields;
import static griffon.util.GriffonClassUtils.getPropertyDescriptors;
import static griffon.util.GriffonClassUtils.setFieldValue;
import static griffon.util.GriffonClassUtils.setPropertiesOrFieldsNoException;
import static griffon.util.GriffonClassUtils.setPropertyOrFieldValueNoException;
import static griffon.util.GriffonNameUtils.capitalize;
import static griffon.util.GriffonNameUtils.isBlank;
import static java.util.Arrays.asList;
import static java.util.Objects.requireNonNull;

/**
 * Base implementation of the {@code MVCGroupManager} interface.
 *
 * @author Andres Almiray
 * @since 2.0.0
 */
public class DefaultMVCGroupManager extends AbstractMVCGroupManager {
<span class="fc" id="L79">    private static final Logger LOG = LoggerFactory.getLogger(DefaultMVCGroupManager.class);</span>
    private static final String CONFIG_KEY_COMPONENT = &quot;component&quot;;
    private static final String CONFIG_KEY_EVENTS_LIFECYCLE = &quot;events.lifecycle&quot;;
    private static final String CONFIG_KEY_EVENTS_INSTANTIATION = &quot;events.instantiation&quot;;
    private static final String CONFIG_KEY_EVENTS_DESTRUCTION = &quot;events.destruction&quot;;
    private static final String CONFIG_KEY_EVENTS_LISTENER = &quot;events.listener&quot;;
    private static final String KEY_PARENT_GROUP = &quot;parentGroup&quot;;

    protected final ApplicationClassLoader applicationClassLoader;
    protected final Instantiator instantiator;

    @Inject
    public DefaultMVCGroupManager(@Nonnull GriffonApplication application, @Nonnull ApplicationClassLoader applicationClassLoader, @Nonnull Instantiator instantiator) {
<span class="fc" id="L92">        super(application);</span>
<span class="fc" id="L93">        this.applicationClassLoader = requireNonNull(applicationClassLoader, &quot;Argument 'applicationClassLoader' must not be null&quot;);</span>
<span class="fc" id="L94">        this.instantiator = requireNonNull(instantiator, &quot;Argument 'instantiator' must not be null&quot;);</span>
<span class="fc" id="L95">    }</span>

    protected void doInitialize(@Nonnull Map&lt;String, MVCGroupConfiguration&gt; configurations) {
<span class="fc" id="L98">        requireNonNull(configurations, &quot;Argument 'configurations' must not be null&quot;);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        for (MVCGroupConfiguration configuration : configurations.values()) {</span>
<span class="fc" id="L100">            addConfiguration(configuration);</span>
<span class="fc" id="L101">        }</span>
<span class="fc" id="L102">    }</span>

    @Nonnull
    protected MVCGroup createMVCGroup(@Nonnull MVCGroupConfiguration configuration, @Nullable String mvcId, @Nonnull Map&lt;String, Object&gt; args) {
<span class="fc" id="L106">        requireNonNull(configuration, ERROR_CONFIGURATION_NULL);</span>
<span class="fc" id="L107">        requireNonNull(args, ERROR_ARGS_NULL);</span>

<span class="fc" id="L109">        mvcId = resolveMvcId(configuration, mvcId);</span>
<span class="fc" id="L110">        checkIdIsUnique(mvcId, configuration);</span>

<span class="fc" id="L112">        LOG.debug(&quot;Building MVC group '{}' with name '{}'&quot;, configuration.getMvcType(), mvcId);</span>
<span class="fc" id="L113">        Map&lt;String, Object&gt; argsCopy = copyAndConfigureArguments(args, configuration, mvcId);</span>

        // figure out what the classes are
<span class="fc" id="L116">        Map&lt;String, ClassHolder&gt; classMap = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        for (Map.Entry&lt;String, String&gt; memberEntry : configuration.getMembers().entrySet()) {</span>
<span class="fc" id="L118">            String memberType = memberEntry.getKey();</span>
<span class="fc" id="L119">            String memberClassName = memberEntry.getValue();</span>
<span class="fc" id="L120">            selectClassesPerMember(memberType, memberClassName, classMap);</span>
<span class="fc" id="L121">        }</span>

<span class="fc" id="L123">        boolean isEventPublishingEnabled = getApplication().getEventRouter().isEventPublishingEnabled();</span>
<span class="fc" id="L124">        getApplication().getEventRouter().setEventPublishingEnabled(isConfigFlagEnabled(configuration, CONFIG_KEY_EVENTS_INSTANTIATION));</span>
<span class="fc" id="L125">        Map&lt;String, Object&gt; instances = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L126">        List&lt;Object&gt; injectedInstances = new ArrayList&lt;&gt;();</span>

        try {
<span class="fc" id="L129">            InjectionUnitOfWork.start();</span>
<span class="nc" id="L130">        } catch (IllegalStateException ise) {</span>
<span class="nc" id="L131">            throw new MVCGroupInstantiationException(&quot;Can not instantiate MVC group '&quot; + configuration.getMvcType() + &quot;' with id '&quot; + mvcId + &quot;'&quot;, configuration.getMvcType(), mvcId, ise);</span>
<span class="fc" id="L132">        }</span>

        try {
<span class="fc" id="L135">            instances.putAll(instantiateMembers(classMap, argsCopy));</span>
        } finally {
<span class="pc" id="L137">            getApplication().getEventRouter().setEventPublishingEnabled(isEventPublishingEnabled);</span>
            try {
<span class="pc" id="L139">                injectedInstances.addAll(InjectionUnitOfWork.finish());</span>
<span class="nc" id="L140">            } catch (IllegalStateException ise) {</span>
<span class="nc" id="L141">                throw new MVCGroupInstantiationException(&quot;Can not instantiate MVC group '&quot; + configuration.getMvcType() + &quot;' with id '&quot; + mvcId + &quot;'&quot;, configuration.getMvcType(), mvcId, ise);</span>
<span class="pc" id="L142">            }</span>
        }

<span class="fc" id="L145">        MVCGroup group = newMVCGroup(configuration, mvcId, instances, (MVCGroup) args.get(KEY_PARENT_GROUP));</span>
<span class="fc" id="L146">        adjustMvcArguments(group, argsCopy);</span>

<span class="fc" id="L148">        boolean fireEvents = isConfigFlagEnabled(configuration, CONFIG_KEY_EVENTS_LIFECYCLE);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (fireEvents) {</span>
<span class="fc" id="L150">            getApplication().getEventRouter().publishEvent(ApplicationEvent.INITIALIZE_MVC_GROUP.getName(), asList(configuration, group));</span>
        }

        // special case -- controllers are added as application listeners
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (isConfigFlagEnabled(group.getConfiguration(), CONFIG_KEY_EVENTS_LISTENER)) {</span>
<span class="fc" id="L155">            GriffonController controller = group.getController();</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (controller != null) {</span>
<span class="fc" id="L157">                getApplication().getEventRouter().addEventListener(controller);</span>
            }
        }

        // mutually set each other to the available fields and inject args
<span class="fc" id="L162">        fillReferencedProperties(group, argsCopy);</span>

<span class="fc" id="L164">        doAddGroup(group);</span>

<span class="fc" id="L166">        initializeMembers(group, argsCopy);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (group instanceof AbstractMVCGroup) {</span>
<span class="fc" id="L168">            ((AbstractMVCGroup) group).getInjectedInstances().addAll(injectedInstances);</span>
        }

<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (fireEvents) {</span>
<span class="fc" id="L172">            getApplication().getEventRouter().publishEvent(ApplicationEvent.CREATE_MVC_GROUP.getName(), asList(group));</span>
        }

<span class="fc" id="L175">        return group;</span>
    }

    protected void adjustMvcArguments(@Nonnull MVCGroup group, @Nonnull Map&lt;String, Object&gt; args) {
        // must set it again because mvcId might have been initialized internally
<span class="fc" id="L180">        args.put(&quot;mvcId&quot;, group.getMvcId());</span>
<span class="fc" id="L181">        args.put(&quot;mvcGroup&quot;, group);</span>
<span class="fc" id="L182">        args.put(&quot;application&quot;, getApplication());</span>
<span class="fc" id="L183">    }</span>

    @Nonnull
    @SuppressWarnings(&quot;ConstantConditions&quot;)
    protected String resolveMvcId(@Nonnull MVCGroupConfiguration configuration, @Nullable String mvcId) {
<span class="fc" id="L188">        boolean component = getConfigValueAsBoolean(configuration.getConfig(), CONFIG_KEY_COMPONENT, false);</span>

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (isBlank(mvcId)) {</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            if (component) {</span>
<span class="nc" id="L192">                mvcId = configuration.getMvcType() + &quot;-&quot; + System.nanoTime();</span>
            } else {
<span class="fc" id="L194">                mvcId = configuration.getMvcType();</span>
            }
        }
<span class="fc" id="L197">        return mvcId;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    protected void selectClassesPerMember(@Nonnull String memberType, @Nonnull String memberClassName, @Nonnull Map&lt;String, ClassHolder&gt; classMap) {
<span class="fc" id="L202">        GriffonClass griffonClass = getApplication().getArtifactManager().findGriffonClass(memberClassName);</span>
<span class="fc" id="L203">        ClassHolder classHolder = new ClassHolder();</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (griffonClass != null) {</span>
<span class="fc" id="L205">            classHolder.artifactClass = (Class&lt;? extends GriffonArtifact&gt;) griffonClass.getClazz();</span>
        } else {
<span class="nc" id="L207">            classHolder.regularClass = loadClass(memberClassName);</span>
        }
<span class="fc" id="L209">        classMap.put(memberType, classHolder);</span>
<span class="fc" id="L210">    }</span>

    @Nonnull
    protected Map&lt;String, Object&gt; copyAndConfigureArguments(@Nonnull Map&lt;String, Object&gt; args, @Nonnull MVCGroupConfiguration configuration, @Nonnull String mvcId) {
<span class="fc" id="L214">        Map&lt;String, Object&gt; argsCopy = CollectionUtils.&lt;String, Object&gt;map()</span>
<span class="fc" id="L215">            .e(&quot;application&quot;, getApplication())</span>
<span class="fc" id="L216">            .e(&quot;mvcType&quot;, configuration.getMvcType())</span>
<span class="fc" id="L217">            .e(&quot;mvcId&quot;, mvcId)</span>
<span class="fc" id="L218">            .e(&quot;configuration&quot;, configuration);</span>

<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (args.containsKey(KEY_PARENT_GROUP)) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (args.get(KEY_PARENT_GROUP) instanceof MVCGroup) {</span>
<span class="nc" id="L222">                MVCGroup parentGroup = (MVCGroup) args.get(KEY_PARENT_GROUP);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">                for (Map.Entry&lt;String, Object&gt; e : parentGroup.getMembers().entrySet()) {</span>
<span class="nc" id="L224">                    args.put(&quot;parent&quot; + capitalize(e.getKey()), e.getValue());</span>
<span class="nc" id="L225">                }</span>
            }
        }

<span class="fc" id="L229">        argsCopy.putAll(args);</span>
<span class="fc" id="L230">        return argsCopy;</span>
    }

    protected void checkIdIsUnique(@Nonnull String mvcId, @Nonnull MVCGroupConfiguration configuration) {
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (findGroup(mvcId) != null) {</span>
<span class="nc" id="L235">            String action = getApplication().getConfiguration().getAsString(&quot;griffon.mvcid.collision&quot;, &quot;exception&quot;);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">            if (&quot;warning&quot;.equalsIgnoreCase(action)) {</span>
<span class="nc" id="L237">                LOG.warn(&quot;A previous instance of MVC group '{}' with id '{}' exists. Destroying the old instance first.&quot;, configuration.getMvcType(), mvcId);</span>
<span class="nc" id="L238">                destroyMVCGroup(mvcId);</span>
            } else {
<span class="nc" id="L240">                throw new MVCGroupInstantiationException(&quot;Can not instantiate MVC group '&quot; + configuration.getMvcType() + &quot;' with id '&quot; + mvcId + &quot;' because a previous instance with that name exists and was not disposed off properly.&quot;, configuration.getMvcType(), mvcId);</span>
            }
        }
<span class="fc" id="L243">    }</span>

    @Nonnull
    protected Map&lt;String, Object&gt; instantiateMembers(@Nonnull Map&lt;String, ClassHolder&gt; classMap, @Nonnull Map&lt;String, Object&gt; args) {
        // instantiate the parts
<span class="fc" id="L248">        Map&lt;String, Object&gt; instanceMap = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">        for (Map.Entry&lt;String, ClassHolder&gt; classEntry : classMap.entrySet()) {</span>
<span class="fc" id="L250">            String memberType = classEntry.getKey();</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">            if (args.containsKey(memberType)) {</span>
                // use provided value, even if null
<span class="nc" id="L253">                instanceMap.put(memberType, args.get(memberType));</span>
            } else {
                // otherwise create a new value
<span class="fc" id="L256">                ClassHolder classHolder = classEntry.getValue();</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">                if (classHolder.artifactClass != null) {</span>
<span class="fc" id="L258">                    Class&lt;? extends GriffonArtifact&gt; memberClass = classHolder.artifactClass;</span>
<span class="fc" id="L259">                    ArtifactManager artifactManager = getApplication().getArtifactManager();</span>
<span class="fc" id="L260">                    GriffonClass griffonClass = artifactManager.findGriffonClass(memberClass);</span>
<span class="fc" id="L261">                    GriffonArtifact instance = artifactManager.newInstance(griffonClass);</span>
<span class="fc" id="L262">                    instanceMap.put(memberType, instance);</span>
<span class="fc" id="L263">                    args.put(memberType, instance);</span>
<span class="fc" id="L264">                } else {</span>
<span class="nc" id="L265">                    Class&lt;?&gt; memberClass = classHolder.regularClass;</span>
                    try {
<span class="nc" id="L267">                        Object instance = instantiator.instantiate(memberClass);</span>
<span class="nc" id="L268">                        instanceMap.put(memberType, instance);</span>
<span class="nc" id="L269">                        args.put(memberType, instance);</span>
<span class="nc" id="L270">                    } catch (RuntimeException e) {</span>
<span class="nc" id="L271">                        LOG.error(&quot;Can't create member {} with {}&quot;, memberType, memberClass);</span>
<span class="nc" id="L272">                        throw new NewInstanceException(memberClass, e);</span>
<span class="nc" id="L273">                    }</span>
                }
            }
<span class="fc" id="L276">        }</span>
<span class="fc" id="L277">        return instanceMap;</span>
    }

    protected void initializeMembers(@Nonnull MVCGroup group, @Nonnull Map&lt;String, Object&gt; args) {
<span class="fc" id="L281">        LOG.debug(&quot;Initializing each MVC member of group '{}'&quot;, group.getMvcId());</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">        for (Map.Entry&lt;String, Object&gt; memberEntry : group.getMembers().entrySet()) {</span>
<span class="fc" id="L283">            String memberType = memberEntry.getKey();</span>
<span class="fc" id="L284">            Object member = memberEntry.getValue();</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">            if (member instanceof GriffonArtifact) {</span>
<span class="fc" id="L286">                initializeArtifactMember(group, memberType, (GriffonArtifact) member, args);</span>
            } else {
<span class="fc" id="L288">                initializeNonArtifactMember(group, memberType, member, args);</span>
            }
<span class="fc" id="L290">        }</span>
<span class="fc" id="L291">    }</span>

    protected void initializeArtifactMember(@Nonnull final MVCGroup group, @Nonnull String type, @Nonnull final GriffonArtifact member, @Nonnull final Map&lt;String, Object&gt; args) {
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (member instanceof GriffonView) {</span>
<span class="fc" id="L295">            getApplication().getUIThreadManager().runInsideUISync(new Runnable() {</span>
                @Override
                public void run() {
                    try {
<span class="fc" id="L299">                        GriffonView view = (GriffonView) member;</span>
<span class="fc" id="L300">                        view.initUI();</span>
<span class="nc" id="L301">                    } catch (RuntimeException e) {</span>
<span class="nc" id="L302">                        throw (RuntimeException) sanitize(new GriffonViewInitializationException(group.getMvcType(), group.getMvcId(), member.getClass().getName(), e));</span>
<span class="fc" id="L303">                    }</span>
<span class="fc" id="L304">                    ((GriffonMvcArtifact) member).mvcGroupInit(args);</span>
<span class="fc" id="L305">                }</span>
            });
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        } else if (member instanceof GriffonMvcArtifact) {</span>
<span class="fc" id="L308">            ((GriffonMvcArtifact) member).mvcGroupInit(args);</span>
        }
<span class="fc" id="L310">    }</span>

    protected void initializeNonArtifactMember(@Nonnull MVCGroup group, @Nonnull String type, @Nonnull Object member, @Nonnull Map&lt;String, Object&gt; args) {
        // empty
<span class="fc" id="L314">    }</span>

    protected static abstract class InjectionPoint {
        protected final String name;
        protected final boolean nullable;
        protected final Type type;

<span class="fc" id="L321">        protected InjectionPoint(String name, boolean nullable, Type type) {</span>
<span class="fc" id="L322">            this.name = name;</span>
<span class="fc" id="L323">            this.nullable = nullable;</span>
<span class="fc" id="L324">            this.type = type;</span>
<span class="fc" id="L325">        }</span>

<span class="pc" id="L327">        protected enum Type {</span>
<span class="fc" id="L328">            MEMBER,</span>
<span class="fc" id="L329">            CONTEXTUAL,</span>
<span class="fc" id="L330">            OTHER</span>
        }

        protected abstract void apply(@Nonnull MVCGroup group, @Nonnull String memberType, @Nonnull Object instance, @Nonnull Map&lt;String, Object&gt; args);
    }

    protected static class FieldInjectionPoint extends InjectionPoint {
        protected final Field field;

        protected FieldInjectionPoint(String name, boolean nullable, Type type, Field field) {
<span class="fc" id="L340">            super(name, nullable, type);</span>
<span class="fc" id="L341">            this.field = field;</span>
<span class="fc" id="L342">        }</span>

        @Override
        protected void apply(@Nonnull MVCGroup group, @Nonnull String memberType, @Nonnull Object instance, @Nonnull Map&lt;String, Object&gt; args) {
<span class="fc" id="L346">            String[] keys = namesFor(field);</span>
<span class="fc" id="L347">            Object argValue = args.get(name);</span>

<span class="pc bpc" id="L349" title="1 of 2 branches missed.">            if (type == Type.CONTEXTUAL) {</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">                for (String key : keys) {</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                    if (group.getContext().containsKey(key)) {</span>
<span class="nc" id="L352">                        argValue = group.getContext().get(key);</span>
<span class="nc" id="L353">                        break;</span>
                    }
                }
            }

<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (argValue == null) {</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">                if (!nullable) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                    if (type == Type.CONTEXTUAL) {</span>
<span class="nc" id="L361">                        throw new IllegalStateException(&quot;Could not find an instance of type &quot; +</span>
<span class="nc" id="L362">                            field.getType().getName() + &quot; under keys '&quot; + Arrays.toString(keys) +</span>
<span class="nc" id="L363">                            &quot;' in the context of MVCGroup[&quot; + group.getMvcType() + &quot;:&quot; + group.getMvcId() +</span>
<span class="nc" id="L364">                            &quot;] to be injected on field '&quot; + field.getName() +</span>
<span class="nc" id="L365">                            &quot;' in &quot; + type + &quot; (&quot; + resolveMemberClass(instance).getName() + &quot;). Field does not accept null values.&quot;);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                    } else if (type == Type.MEMBER) {</span>
<span class="nc" id="L367">                        throw new IllegalStateException(&quot;Could not inject argument on field '&quot;</span>
<span class="nc" id="L368">                            + name + &quot;' in &quot; + memberType + &quot; (&quot; + resolveMemberClass(instance).getName() +</span>
                            &quot;). Field does not accept null values.&quot;);
                    }
                }
<span class="fc" id="L372">                return;</span>
            }

            try {
<span class="nc" id="L376">                setFieldValue(instance, name, argValue);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (type == Type.OTHER) {</span>
<span class="nc" id="L378">                    LOG.warn(&quot;Field '&quot; + name + &quot;' in &quot; + memberType + &quot; (&quot; + resolveMemberClass(instance).getName() +</span>
<span class="nc" id="L379">                        &quot;) must be annotated with @&quot; + MVCMember.class.getName() + &quot;.&quot;);</span>
                }
<span class="nc" id="L381">            } catch (FieldException e) {</span>
<span class="nc" id="L382">                throw new MVCGroupInstantiationException(group.getMvcType(), group.getMvcId(), e);</span>
<span class="nc" id="L383">            }</span>
<span class="nc" id="L384">        }</span>
    }

    protected static class MethodInjectionPoint extends InjectionPoint {
        protected final Method method;

        protected MethodInjectionPoint(String name, boolean nullable, Type type, Method method) {
<span class="fc" id="L391">            super(name, nullable, type);</span>
<span class="fc" id="L392">            this.method = method;</span>
<span class="fc" id="L393">        }</span>

        @Override
        protected void apply(@Nonnull MVCGroup group, @Nonnull String memberType, @Nonnull Object instance, @Nonnull Map&lt;String, Object&gt; args) {
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">            if (type == Type.CONTEXTUAL) {</span>
<span class="nc" id="L398">                String[] keys = namesFor(method);</span>
<span class="nc" id="L399">                Object argValue = args.get(name);</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">                for (String key : keys) {</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                    if (group.getContext().containsKey(key)) {</span>
<span class="nc" id="L403">                        argValue = group.getContext().get(key);</span>
<span class="nc" id="L404">                        break;</span>
                    }
                }

<span class="nc bnc" id="L408" title="All 4 branches missed.">                if (argValue == null &amp;&amp; !nullable) {</span>
<span class="nc" id="L409">                    throw new IllegalStateException(&quot;Could not find an instance of type &quot; +</span>
<span class="nc" id="L410">                        method.getParameterTypes()[0].getName() + &quot; under keys '&quot; + Arrays.toString(keys) +</span>
<span class="nc" id="L411">                        &quot;' in the context of MVCGroup[&quot; + group.getMvcType() + &quot;:&quot; + group.getMvcId() +</span>
                        &quot;] to be injected on property '&quot; + name +
<span class="nc" id="L413">                        &quot;' in &quot; + type + &quot; (&quot; + resolveMemberClass(instance).getName() + &quot;). Property does not accept null values.&quot;);</span>
                }

                try {
<span class="nc" id="L417">                    method.invoke(instance, argValue);</span>
<span class="nc" id="L418">                } catch (IllegalAccessException | InvocationTargetException e) {</span>
<span class="nc" id="L419">                    throw new MVCGroupInstantiationException(group.getMvcType(), group.getMvcId(), e);</span>
<span class="nc" id="L420">                }</span>
<span class="nc" id="L421">            } else {</span>
<span class="fc" id="L422">                Object argValue = args.get(name);</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">                if (argValue == null) {</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">                    if (!nullable) {</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">                        if (type == Type.MEMBER) {</span>
<span class="nc" id="L426">                            throw new IllegalStateException(&quot;Could not inject argument on property '&quot; +</span>
<span class="nc" id="L427">                                name + &quot;' in &quot; + memberType + &quot; (&quot; + resolveMemberClass(instance).getName() +</span>
                                &quot;). Property does not accept null values.&quot;);
                        }
                    }
<span class="fc" id="L431">                    return;</span>
                }

                try {
<span class="fc" id="L435">                    method.invoke(instance, argValue);</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">                    if (type == Type.OTHER) {</span>
<span class="nc" id="L437">                        LOG.warn(&quot;Property '&quot; + name + &quot;' in &quot; + memberType + &quot; (&quot; + resolveMemberClass(instance).getName() +</span>
<span class="nc" id="L438">                            &quot;) must be annotated with @&quot; + MVCMember.class.getName() + &quot;.&quot;);</span>
                    }
<span class="nc" id="L440">                } catch (IllegalAccessException | InvocationTargetException e) {</span>
<span class="nc" id="L441">                    throw new MVCGroupInstantiationException(group.getMvcType(), group.getMvcId(), e);</span>
<span class="fc" id="L442">                }</span>
            }
<span class="fc" id="L444">        }</span>
    }

    protected void fillReferencedProperties(@Nonnull MVCGroup group, @Nonnull Map&lt;String, Object&gt; args) {
<span class="fc bfc" id="L448" title="All 2 branches covered.">        for (Map.Entry&lt;String, Object&gt; memberEntry : group.getMembers().entrySet()) {</span>
<span class="fc" id="L449">            String memberType = memberEntry.getKey();</span>
<span class="fc" id="L450">            Object member = memberEntry.getValue();</span>

<span class="fc" id="L452">            Map&lt;String, Object&gt; argsCopy = new LinkedHashMap&lt;&gt;(args);</span>

<span class="fc" id="L454">            Map&lt;String, Field&gt; fields = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">            for (Field field : getAllDeclaredFields(resolveMemberClass(member))) {</span>
<span class="fc" id="L456">                fields.put(field.getName(), field);</span>
            }
<span class="fc" id="L458">            Map&lt;String, InjectionPoint&gt; injectionPoints = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L459" title="All 2 branches covered.">            for (PropertyDescriptor descriptor : getPropertyDescriptors(resolveMemberClass(member))) {</span>
<span class="fc" id="L460">                Method method = descriptor.getWriteMethod();</span>
<span class="pc bpc" id="L461" title="1 of 4 branches missed.">                if (method == null || isInjectable(method)) { continue; }</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">                boolean nullable = findAnnotation(annotationsOfMethodParameter(method, 0), Nonnull.class) == null;</span>
<span class="fc" id="L463">                InjectionPoint.Type type = resolveType(method);</span>
<span class="fc" id="L464">                Field field = fields.get(descriptor.getName());</span>
<span class="pc bpc" id="L465" title="1 of 4 branches missed.">                if (field != null &amp;&amp; type == InjectionPoint.Type.OTHER) {</span>
<span class="fc" id="L466">                    type = resolveType(field);</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">                    nullable = field.getAnnotation(Nonnull.class) == null;</span>
                }
<span class="fc" id="L469">                injectionPoints.put(descriptor.getName(), new MethodInjectionPoint(descriptor.getName(), nullable, type, method));</span>
            }

<span class="fc bfc" id="L472" title="All 2 branches covered.">            for (Field field : getAllDeclaredFields(resolveMemberClass(member))) {</span>
<span class="fc bfc" id="L473" title="All 4 branches covered.">                if (Modifier.isStatic(field.getModifiers()) || isInjectable(field)) { continue; }</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">                if (!injectionPoints.containsKey(field.getName())) {</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">                    boolean nullable = field.getAnnotation(Nonnull.class) == null;</span>
<span class="fc" id="L476">                    InjectionPoint.Type type = resolveType(field);</span>
<span class="fc" id="L477">                    injectionPoints.put(field.getName(), new FieldInjectionPoint(field.getName(), nullable, type, field));</span>
                }
            }

<span class="fc bfc" id="L481" title="All 2 branches covered.">            for (InjectionPoint ip : injectionPoints.values()) {</span>
<span class="fc" id="L482">                ip.apply(group, memberType, member, args);</span>
<span class="fc" id="L483">                argsCopy.remove(ip.name);</span>
<span class="fc" id="L484">            }</span>

            /*
            for (Map.Entry&lt;String, Object&gt; e : argsCopy.entrySet()) {
                try {
                    setPropertyOrFieldValue(member, e.getKey(), e.getValue());
                    LOG.warn(&quot;Property '&quot; + e.getKey() + &quot;' in &quot; + memberType + &quot; (&quot; + resolveMemberClass(member).getName() +
                        &quot;) must be annotated with @&quot; + MVCMember.class.getName() + &quot;.&quot;);
                } catch (PropertyException ignored) {
                    // OK
                }
            }
            */
<span class="fc" id="L497">            setPropertiesOrFieldsNoException(member, argsCopy);</span>
<span class="fc" id="L498">        }</span>
<span class="fc" id="L499">    }</span>

    @Nonnull
    protected InjectionPoint.Type resolveType(@Nonnull AnnotatedElement element) {
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        if (isContextual(element)) {</span>
<span class="nc" id="L504">            return InjectionPoint.Type.CONTEXTUAL;</span>
<span class="fc bfc" id="L505" title="All 2 branches covered.">        } else if (isMvcMember(element)) {</span>
<span class="fc" id="L506">            return InjectionPoint.Type.MEMBER;</span>
        }
<span class="fc" id="L508">        return InjectionPoint.Type.OTHER;</span>
    }

    protected boolean isContextual(AnnotatedElement element) {
<span class="pc bpc" id="L512" title="2 of 4 branches missed.">        return element != null &amp;&amp; element.getAnnotation(Contextual.class) != null;</span>
    }

    protected boolean isInjectable(AnnotatedElement element) {
<span class="pc bpc" id="L516" title="1 of 4 branches missed.">        return element != null &amp;&amp; element.getAnnotation(Inject.class) != null;</span>
    }

    protected boolean isMvcMember(AnnotatedElement element) {
<span class="pc bpc" id="L520" title="1 of 4 branches missed.">        return element != null &amp;&amp; element.getAnnotation(MVCMember.class) != null;</span>
    }

    protected void doAddGroup(@Nonnull MVCGroup group) {
<span class="fc" id="L524">        addGroup(group);</span>
<span class="fc" id="L525">    }</span>

    public void destroyMVCGroup(@Nonnull String mvcId) {
<span class="fc" id="L528">        MVCGroup group = findGroup(mvcId);</span>
<span class="fc" id="L529">        LOG.debug(&quot;Group '{}' points to {}&quot;, mvcId, group);</span>

<span class="fc bfc" id="L531" title="All 2 branches covered.">        if (group == null) { return; }</span>

<span class="fc" id="L533">        LOG.debug(&quot;Destroying MVC group identified by '{}'&quot;, mvcId);</span>

<span class="pc bpc" id="L535" title="1 of 2 branches missed.">        if (isConfigFlagEnabled(group.getConfiguration(), CONFIG_KEY_EVENTS_LISTENER)) {</span>
<span class="fc" id="L536">            GriffonController controller = group.getController();</span>
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">            if (controller != null) {</span>
<span class="fc" id="L538">                getApplication().getEventRouter().removeEventListener(controller);</span>
            }
        }

<span class="fc" id="L542">        boolean fireDestructionEvents = isConfigFlagEnabled(group.getConfiguration(), CONFIG_KEY_EVENTS_DESTRUCTION);</span>

<span class="fc" id="L544">        destroyMembers(group, fireDestructionEvents);</span>

<span class="fc" id="L546">        doRemoveGroup(group);</span>
<span class="fc" id="L547">        group.destroy();</span>

<span class="pc bpc" id="L549" title="1 of 2 branches missed.">        if (isConfigFlagEnabled(group.getConfiguration(), CONFIG_KEY_EVENTS_LIFECYCLE)) {</span>
<span class="fc" id="L550">            getApplication().getEventRouter().publishEvent(ApplicationEvent.DESTROY_MVC_GROUP.getName(), asList(group));</span>
        }
<span class="fc" id="L552">    }</span>

    protected void destroyMembers(@Nonnull MVCGroup group, boolean fireDestructionEvents) {
<span class="fc bfc" id="L555" title="All 2 branches covered.">        for (Map.Entry&lt;String, Object&gt; memberEntry : group.getMembers().entrySet()) {</span>
<span class="fc" id="L556">            Object member = memberEntry.getValue();</span>
<span class="fc bfc" id="L557" title="All 2 branches covered.">            if (member instanceof GriffonArtifact) {</span>
<span class="fc" id="L558">                destroyArtifactMember(memberEntry.getKey(), (GriffonArtifact) member, fireDestructionEvents);</span>
            } else {
<span class="fc" id="L560">                destroyNonArtifactMember(memberEntry.getKey(), member, fireDestructionEvents);</span>
            }

<span class="fc" id="L563">        }</span>

<span class="pc bpc" id="L565" title="1 of 2 branches missed.">        if (group instanceof AbstractMVCGroup) {</span>
<span class="fc" id="L566">            List&lt;Object&gt; injectedInstances = ((AbstractMVCGroup) group).getInjectedInstances();</span>
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">            for (Object instance : injectedInstances) {</span>
<span class="nc" id="L568">                getApplication().getInjector().release(instance);</span>
<span class="nc" id="L569">            }</span>
<span class="fc" id="L570">            injectedInstances.clear();</span>
        }
<span class="fc" id="L572">    }</span>

    protected void destroyArtifactMember(@Nonnull String type, @Nonnull GriffonArtifact member, boolean fireDestructionEvents) {
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">        if (member instanceof GriffonMvcArtifact) {</span>
<span class="fc" id="L576">            final GriffonMvcArtifact artifact = (GriffonMvcArtifact) member;</span>
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">            if (fireDestructionEvents) {</span>
<span class="fc" id="L578">                getApplication().getEventRouter().publishEvent(ApplicationEvent.DESTROY_INSTANCE.getName(), asList(artifact.getTypeClass(), artifact));</span>
            }

<span class="fc bfc" id="L581" title="All 2 branches covered.">            if (artifact instanceof GriffonView) {</span>
<span class="fc" id="L582">                getApplication().getUIThreadManager().runInsideUISync(new Runnable() {</span>
                    @Override
                    public void run() {
                        try {
<span class="fc" id="L586">                            artifact.mvcGroupDestroy();</span>
<span class="nc" id="L587">                        } catch (RuntimeException e) {</span>
<span class="nc" id="L588">                            throw (RuntimeException) sanitize(e);</span>
<span class="fc" id="L589">                        }</span>
<span class="fc" id="L590">                    }</span>
                });
            } else {
<span class="fc" id="L593">                artifact.mvcGroupDestroy();</span>
            }

            // clear all parent* references
<span class="fc bfc" id="L597" title="All 2 branches covered.">            for (String parentMemberName : new String[]{&quot;parentModel&quot;, &quot;parentView&quot;, &quot;parentController&quot;, &quot;parentGroup&quot;}) {</span>
<span class="fc" id="L598">                setPropertyOrFieldValueNoException(member, parentMemberName, null);</span>
            }
        }

<span class="fc" id="L602">        destroyContextualMemberProperties(type, member);</span>
<span class="fc" id="L603">    }</span>

    protected void destroyContextualMemberProperties(@Nonnull String type, @Nonnull GriffonArtifact member) {
<span class="fc bfc" id="L606" title="All 2 branches covered.">        for (Field field : getAllDeclaredFields(member.getTypeClass())) {</span>
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">            if (isContextual(field)) {</span>
                try {
<span class="nc" id="L609">                    setFieldValue(member, field.getName(), null);</span>
<span class="nc" id="L610">                } catch (FieldException e) {</span>
<span class="nc" id="L611">                    throw new IllegalStateException(&quot;Could not nullify field &quot; +</span>
<span class="nc" id="L612">                        field.getName() + &quot;' in &quot; + type + &quot; (&quot; + member.getTypeClass().getName() + &quot;)&quot;, e);</span>
<span class="nc" id="L613">                }</span>
            }
        }
<span class="fc" id="L616">    }</span>

    protected void destroyNonArtifactMember(@Nonnull String type, @Nonnull Object member, boolean fireDestructionEvents) {
        // empty
<span class="fc" id="L620">    }</span>

    protected void doRemoveGroup(@Nonnull MVCGroup group) {
<span class="fc" id="L623">        removeGroup(group);</span>
<span class="fc" id="L624">    }</span>

    protected boolean isConfigFlagEnabled(@Nonnull MVCGroupConfiguration configuration, @Nonnull String key) {
<span class="fc" id="L627">        return getConfigValueAsBoolean(configuration.getConfig(), key, true);</span>
    }

    @Nonnull
    private static Class&lt;?&gt; resolveMemberClass(@Nonnull Object member) {
<span class="fc bfc" id="L632" title="All 2 branches covered.">        if (member instanceof GriffonArtifact) {</span>
<span class="fc" id="L633">            return ((GriffonArtifact) member).getTypeClass();</span>
        }
<span class="fc" id="L635">        return member.getClass();</span>
    }

    @Nullable
    protected Class&lt;?&gt; loadClass(@Nonnull String className) {
        try {
<span class="nc" id="L641">            return applicationClassLoader.get().loadClass(className);</span>
<span class="nc" id="L642">        } catch (ClassNotFoundException e) {</span>
            // #39 do not ignore this CNFE
<span class="nc" id="L644">            throw new GriffonException(e.toString(), e);</span>
        }
    }

<span class="fc" id="L648">    protected static final class ClassHolder {</span>
        protected Class&lt;?&gt; regularClass;
        protected Class&lt;? extends GriffonArtifact&gt; artifactClass;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>