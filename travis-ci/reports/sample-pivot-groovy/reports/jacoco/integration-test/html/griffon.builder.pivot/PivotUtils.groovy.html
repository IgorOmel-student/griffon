<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PivotUtils.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-pivot-groovy</a> &gt; <a href="index.source.html" class="el_package">griffon.builder.pivot</a> &gt; <span class="el_source">PivotUtils.groovy</span></div><h1>PivotUtils.groovy</h1><pre class="source lang-java linenums">/*
 * Copyright 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package griffon.builder.pivot

import org.apache.pivot.collections.Dictionary
import org.apache.pivot.collections.List as PivotList
import org.apache.pivot.collections.Map as PivotMap
import org.apache.pivot.collections.Sequence
import org.apache.pivot.collections.Set as PivotSet
import org.apache.pivot.util.ListenerList
import org.apache.pivot.wtk.Component
import org.apache.pivot.wtk.Form
import org.apache.pivot.wtk.TabPane
import org.apache.pivot.wtk.text.Span

import static griffon.util.GriffonNameUtils.getSetterName

/**
 * @author Andres Almiray
 */
final class PivotUtils {
    private PivotUtils() {}

    private static final String ENHANCED = &quot;_ENHANCED_METACLASS_&quot;

    static boolean hasBeenEnhanced(Class klass) {
<span class="nc" id="L40">        MetaClassRegistry mcr = GroovySystem.metaClassRegistry</span>
<span class="nc" id="L41">        MetaClass mc = mcr.getMetaClass(klass)</span>
<span class="nc bnc" id="L42" title="All 4 branches missed.">        if (!(mc instanceof ExpandoMetaClass)) return false</span>
<span class="nc" id="L43">        return mc.hasMetaProperty(ENHANCED)</span>
    }

    static void enhance(Class klass, Map enhancedMethods) {
<span class="nc" id="L47">        MetaClassRegistry mcr = GroovySystem.metaClassRegistry</span>
<span class="nc" id="L48">        MetaClass mc = mcr.getMetaClass(klass)</span>
<span class="nc" id="L49">        boolean init = false</span>
<span class="nc bnc" id="L50" title="All 14 branches missed.">        if (!(mc instanceof ExpandoMetaClass) ||</span>
<span class="nc bnc" id="L51" title="All 20 branches missed.">            (mc instanceof ExpandoMetaClass &amp;&amp; !mc.isModified())) {</span>
<span class="nc" id="L52">            mcr.removeMetaClass klass</span>
<span class="nc" id="L53">            mc = new ExpandoMetaClass(klass)</span>
<span class="nc" id="L54">            init = true</span>
        }
        // if mc is an EMC that was initialized previously
        // with additional methods/properties and it does
        // not allow modifications after init, then the next
        // block will throw an exception
<span class="nc" id="L60">        enhancedMethods.each { k, v -&gt;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (mc.getMetaMethod(k) == null) {</span>
<span class="nc" id="L62">                mc.registerInstanceMethod(k, v)</span>
            }
        }
<span class="nc" id="L65">        mc.registerBeanProperty(ENHANCED, true)</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (init) {</span>
<span class="nc" id="L67">            mc.initialize()</span>
<span class="nc" id="L68">            mcr.setMetaClass(klass, mc)</span>
        }
    }

    static enhanceClasses() {
<span class="nc" id="L73">        enhance(Sequence, [</span>
<span class="nc" id="L74">            iterator: {-&gt; new FixedIterator(delegate, true) },</span>
<span class="nc" id="L75">            size: {-&gt; delegate.getLength() },</span>
<span class="nc" id="L76">            getAt: { i -&gt; delegate.get(i) },</span>
<span class="nc" id="L77">            putAt: { i, e -&gt; delegate.update(i, e) }</span>
        ])
<span class="nc" id="L79">        enhance(ListenerList, [</span>
<span class="nc" id="L80">            leftShift: { e -&gt; delegate.add(e) }</span>
        ])
<span class="nc" id="L82">        enhance(PivotList, [</span>
<span class="nc" id="L83">            leftShift: { e -&gt; delegate.add(e) }</span>
        ])
<span class="nc" id="L85">        enhance(PivotSet, [</span>
<span class="nc" id="L86">            leftShift: { e -&gt; delegate.add(e) },</span>
<span class="nc" id="L87">            size: {-&gt; delegate.getCount() }</span>
        ])
<span class="nc" id="L89">        enhance(Dictionary, [</span>
<span class="nc" id="L90">            putAt: { k, v -&gt; delegate.put(k, v) },</span>
<span class="nc" id="L91">            getAt: { k -&gt; delegate.get(k) }</span>
        ])
<span class="nc" id="L93">        enhance(PivotMap, [</span>
<span class="nc" id="L94">            size: {-&gt; delegate.getCount() }</span>
        ])
<span class="nc" id="L96">        enhance(Span, [</span>
<span class="nc" id="L97">            asRange: {-&gt; new IntRange(delegate.start, delegate.end) },</span>
<span class="nc" id="L98">            size: {-&gt; delegate.getLength() }</span>
        ])
<span class="nc" id="L100">        enhance(Component, [</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            setFormLabel: { label -&gt; Form.setLabel(delegate, label ? label.toString() : null) },</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            setFormFlag: { flag -&gt; flag ? Form.setFlag(delegate, flag) : Form.setFlag(delegate, (Form.Flag) null) },</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            setTabLabel: { label -&gt; TabPane.setLabel(delegate, label ? label.toString() : null) },</span>
        ])
    }

    static void setBeanProperty(String propertyName, value, bean) {
        try {
            // use setter method instead of property access
            // workaround to multiple property setters &amp; single property getter
<span class="fc" id="L111">            String setter = getSetterName(propertyName)</span>
<span class="pc" id="L112">            bean.&quot;$setter&quot;(value)</span>
        } catch (MissingPropertyException mpe) {
<span class="pc" id="L114">            bean.styles.put(propertyName, value)</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>