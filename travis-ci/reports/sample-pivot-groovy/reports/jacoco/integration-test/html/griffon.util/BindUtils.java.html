<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BindUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-pivot-groovy</a> &gt; <a href="index.source.html" class="el_package">griffon.util</a> &gt; <span class="el_source">BindUtils.java</span></div><h1>BindUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2008-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package griffon.util;

import griffon.core.CallableWithArgs;
import groovy.lang.Closure;
import groovy.util.FactoryBuilderSupport;

import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import java.util.LinkedHashMap;
import java.util.Map;

import static griffon.util.GriffonNameUtils.isBlank;
import static java.util.Objects.requireNonNull;

/**
 * Helper class for constructing bindings between two objects.
 *
 * @author Andres Almiray
 * @since 2.0.0
 */
<span class="nc" id="L36">public class BindUtils {</span>
    /**
     * Create a new Binding using a builder.
     */
    @Nonnull
    public static BindingBuilder binding() {
<span class="nc" id="L42">        return new BindingBuilder();</span>
    }

<span class="nc" id="L45">    public static class BindingBuilder {</span>
        private Object source;
        private Object target;
        private String sourceProperty;
        private String targetProperty;
        private CallableWithArgs&lt;?&gt; converter;
        private CallableWithArgs&lt;?&gt; validator;
        private boolean mutual;

        @Nonnull
        public BindingBuilder withSource(@Nullable Object source) {
<span class="nc" id="L56">            this.source = source;</span>
<span class="nc" id="L57">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withTarget(@Nullable Object target) {
<span class="nc" id="L62">            this.target = target;</span>
<span class="nc" id="L63">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withSourceProperty(@Nullable String sourceProperty) {
<span class="nc" id="L68">            this.sourceProperty = sourceProperty;</span>
<span class="nc" id="L69">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withTargetProperty(@Nullable String targetProperty) {
<span class="nc" id="L74">            this.targetProperty = targetProperty;</span>
<span class="nc" id="L75">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withConverter(@Nullable CallableWithArgs&lt;?&gt; converter) {
<span class="nc" id="L80">            this.converter = converter;</span>
<span class="nc" id="L81">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withValidator(@Nullable CallableWithArgs&lt;?&gt; validator) {
<span class="nc" id="L86">            this.validator = validator;</span>
<span class="nc" id="L87">            return this;</span>
        }

        @Nonnull
        public BindingBuilder withMutual(boolean mutual) {
<span class="nc" id="L92">            this.mutual = mutual;</span>
<span class="nc" id="L93">            return this;</span>
        }

        public void make(@Nonnull FactoryBuilderSupport builder) {
<span class="nc" id="L97">            requireNonNull(builder, &quot;Cannot make binding with a null builder!&quot;);</span>
<span class="nc" id="L98">            requireNonNull(source, &quot;Unspecified value for: source&quot;);</span>
<span class="nc" id="L99">            requireNonNull(target, &quot;Unspecified value for: target&quot;);</span>

<span class="nc" id="L101">            Map&lt;String, Object&gt; attributes = new LinkedHashMap&lt;&gt;();</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (isBlank(sourceProperty)) sourceProperty = targetProperty;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (isBlank(sourceProperty)) {</span>
<span class="nc" id="L105">                throw new IllegalArgumentException(&quot;Unspecified values for: sourceProperty, targetProperty&quot;);</span>
            }
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (isBlank(targetProperty)) targetProperty = sourceProperty;</span>

<span class="nc" id="L109">            attributes.put(&quot;source&quot;, source);</span>
<span class="nc" id="L110">            attributes.put(&quot;target&quot;, target);</span>
<span class="nc" id="L111">            attributes.put(&quot;sourceProperty&quot;, sourceProperty);</span>
<span class="nc" id="L112">            attributes.put(&quot;targetProperty&quot;, targetProperty);</span>
<span class="nc" id="L113">            attributes.put(&quot;mutual&quot;, mutual);</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (converter != null) {</span>
<span class="nc" id="L116">                attributes.put(&quot;converter&quot;, makeClosure(builder, converter));</span>
            }
<span class="nc bnc" id="L118" title="All 2 branches missed.">            if (validator != null) {</span>
<span class="nc" id="L119">                attributes.put(&quot;validator&quot;, makeClosure(builder, validator));</span>
            }

<span class="nc" id="L122">            builder.invokeMethod(&quot;bind&quot;, attributes);</span>
<span class="nc" id="L123">        }</span>

        private Closure&lt;?&gt; makeClosure(@Nonnull FactoryBuilderSupport builder, @Nonnull final CallableWithArgs&lt;?&gt; callback) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (callback instanceof Closure) {</span>
<span class="nc" id="L127">                return (Closure&lt;?&gt;) callback;</span>
            }
<span class="nc" id="L129">            return new Closure&lt;Object&gt;(builder) {</span>
                private static final long serialVersionUID = -4108869890482462552L;

                @Override
                public Object call(Object... args) {
<span class="nc" id="L134">                    return callback.call(args);</span>
                }

                @Override
                public Object call(Object args) {
<span class="nc" id="L139">                    return callback.call(args);</span>
                    // return callback.call(arguments != null &amp;&amp; arguments.getClass().isArray() ? (Object[]) arguments : new Object[]{arguments});
                }
            };
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>